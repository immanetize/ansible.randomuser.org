- name: install dkim packages
  dnf:
    name={{item}}
    state=present
  with_items:
    - opendkim
    - pypolicyd-spf
- name: generate dkim keys
  shell: "
    /usr/sbin/opendkim-genkey 
    --bits 2048 
    --domain randomuser.org 
    --directory /etc/opendkim/keys
    --restrict 
    --selector {{ansible_fqdn}} 
    creates=/etc/opendkim/keys/{{ansible_fqdn}}.private"
- name: get dkim TXT record data
  shell: cat /etc/opendkim/keys/proteus.randomuser.org.txt | tr '\n' ' ' | sed -e 's/"\s*"//g' -ne 's/^.*"\(.*\)".*/\1/p'
  register: dkim_txt_record
- name: debug txt record data
  debug: var=dkim_txt_record


- name: correct file ownership
  file:
     path=/etc/opendkim
     recurse=yes
     owner=opendkim
     group=opendkim
- name: copy opendkim config
  template:
    src=opendkim/opendkim.conf
    dest=/etc/opendkim.conf

- name: create SPF record
  delegate_to: localhost
  rax_dns_record:
    creds_file="{{rax_creds_file}}"
    data="{{dkim_txt_record.stdout}}"    
    domain="{{'.'.join(ansible_fqdn.split('.')[1:])}}"
    name="default._domainkey.{{'.'.join(ansible_fqdn.split('.')[1:])}}"
    region=DFW
    state=present
    type=TXT
